# Совместимость с NixOS 25.05+

## Обзор

В NixOS 25.05+ были внесены изменения, которые затрагивают конфигурацию VirtualBox Guest Additions. Наши скрипты автоматически обрабатывают эти изменения.

## Изменения в NixOS 25.05+

### Удаленные опции VirtualBox

- `virtualisation.virtualbox.guest.x11 = true;` - эта опция была удалена
- X11 поддержка для VirtualBox теперь включается автоматически при установке Guest Additions

### Автоматические исправления

Наши скрипты (`install-configs.sh` и `fix-config.sh`) автоматически:

1. **Определяют версию NixOS**
   ```bash
   nixos-version | grep -o '[0-9][0-9]\.[0-9][0-9]'
   ```

2. **Удаляют устаревшие опции** для NixOS 25.05+:
   - Убирают строку с `virtualisation.virtualbox.guest.x11`
   - Добавляют комментарий о совместимости

3. **Сохраняют работоспособность** на старых версиях NixOS

## Какие файлы проверяются

- `configuration.nix`
- `hardware-configuration.nix`

## Для пользователей

### Если вы используете NixOS 24.11 или старше
- Ничего делать не нужно
- Скрипты сохранят совместимость

### Если вы используете NixOS 25.05+
- Скрипты автоматически удалят устаревшие опции
- VirtualBox Guest Additions будут работать как обычно

## Ручное исправление (если нужно)

Если вы хотите исправить конфигурацию вручную:

```bash
# Удалить устаревшую опцию
sudo sed -i '/virtualisation.virtualbox.guest.x11/d' /etc/nixos/hardware-configuration.nix

# Пересобрать систему
sudo nixos-rebuild switch
```

## Проверка совместимости

Чтобы проверить, нужны ли исправления:

```bash
# Проверить версию NixOS
nixos-version

# Проверить наличие устаревших опций
grep -n "virtualisation.virtualbox.guest.x11" /etc/nixos/*.nix
```

## Техническая информация

### Почему была удалена опция?

В NixOS 25.05+ разработчики упростили конфигурацию VirtualBox:
- X11 поддержка включается автоматически
- Нет необходимости в явном указании опции
- Улучшена интеграция с современными системами отображения

### Обратная совместимость

Наши скрипты поддерживают:
- NixOS 24.05, 24.11 (со старыми опциями)
- NixOS 25.05+ (с новой системой)
- Автоматическое определение и исправление

## Устранение проблем

### Ошибка "attribute 'x11' missing"

Если вы видите ошибку:
```
error: attribute 'x11' in selection path 'virtualisation.virtualbox.guest.x11' not found
```

**Решение:**
```bash
# Запустить наш скрипт исправления
sudo ./fix-config.sh

# Или использовать полную установку
sudo ./install-configs.sh
```

### Проблемы с кодировкой и отображением символов

Если символы в терминале отображаются как квадратики:

**Диагностика:**
```bash
# Тест отображения символов
./test-encoding.sh

# Исправление проблем с кодировкой
sudo ./fix-encoding.sh
```

**Причины проблем:**
- Неправильная кодировка скриптов
- Отсутствуют нужные шрифты
- Неправильные переменные окружения
- Настройки терминала

**Автоматическое исправление:**
Наши скрипты автоматически:
- Устанавливают UTF-8 переменные окружения
- Добавляют дополнительные шрифты (JetBrains Mono, DejaVu, etc.)
- Создают правильную конфигурацию Kitty terminal
- Настраивают fontconfig для корректного отображения

### Проверка после исправления

```bash
# Проверить синтаксис
sudo nixos-rebuild dry-build

# Применить изменения
sudo nixos-rebuild switch
```

## Поддержка

Если у вас возникли проблемы с совместимостью:

1. Запустите диагностику: `./diagnose-config.sh`
2. Посмотрите логи: `journalctl -u nixos-rebuild`
3. Проверьте файлы конфигурации на синтаксические ошибки

---

*Этот документ обновляется автоматически при изменениях в NixOS.*
